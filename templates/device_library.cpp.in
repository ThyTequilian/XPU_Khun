#include "@DeviceLibrary@.h"

#include <memory>

#if XPU_IS_CUDA
#define XPU_DEVICE_LIBRARY @DeviceLibrary@_Cuda
#elif XPU_IS_HIP
#warning "DeviceLibrary_Hip"
#define XPU_DEVICE_LIBRARY @DeviceLibrary@_Hip
#else // XPU_IS_CPU
#define XPU_DEVICE_LIBRARY @DeviceLibrary@_Cpu
#endif

#if XPU_IS_CPU
@DeviceLibrary@ &@DeviceLibrary@::instance(xpu::driver type) {
    static @DeviceLibrary@_Cpu libCpu{};
    static std::unique_ptr<xpu::lib_obj<@DeviceLibrary@>> libCuda{};
    static std::unique_ptr<xpu::lib_obj<@DeviceLibrary@>> libHip{};

    switch (type) {
        case xpu::driver::cpu:
            return libCpu;
        case xpu::driver::cuda:
            if (libCuda == nullptr) {
                libCuda.reset(new xpu::lib_obj<@DeviceLibrary@>{"lib@DeviceLibrary@_Cuda.so"});
            }
            return *libCuda->obj;
        case xpu::driver::hip:
            if (libHip == nullptr) {
                libHip.reset(new xpu::lib_obj<@DeviceLibrary@>{"lib@DeviceLibrary@_Hip.so"});
            }
            return *libHip->obj;
    
    }

    // unreachable
    return libCpu;
}
#else
extern "C" @DeviceLibrary@ *create() {
    return new XPU_DEVICE_LIBRARY{};
}

extern "C" void destroy(@DeviceLibrary@ *obj) {
    delete obj;
}
#endif

#define XPU_KERNEL_DECL(...)
#if XPU_IS_HIP_CUDA
#include <xpu/driver/hip_cuda/cmem_impl.h>
#else // XPU_IS_CPU
#include <xpu/driver/cpu/cmem_impl.h>
#endif
#include <@KernelDeclFullPath@>
#undef XPU_CMEM_DECL
#undef XPU_KERNEL_DECL

#undef XPU_DEVICE_LIBRARY