#define LibT XPU_DEVICE_LIBRARY
#define BackendT XPU_CONCAT(XPU_DEVICE_LIBRARY, XPU_DRIVER_NAME)
#define LibObject(driver) "lib" XPU_STRINGIZE(LibT) XPU_STRINGIZE(driver) ".so"

#if XPU_IS_CPU
LibT &LibT::instance(xpu::driver type) {
    static BackendT testKernelsCPU{};
    static std::unique_ptr<xpu::lib_obj<LibT>> testKernelsCUDA{};

    switch (type) {
        case xpu::driver::cpu:
            return testKernelsCPU;
        case xpu::driver::cuda:
            if (testKernelsCUDA == nullptr) {
                testKernelsCUDA.reset(new xpu::lib_obj<LibT>{LibObject(CUDA)});
            }
            return *testKernelsCUDA->obj;
    }

    // unreachable
    return testKernelsCPU;
}
#else
extern "C" LibT *create() {
    return new BackendT{};
}

extern "C" void destroy(LibT *obj) {
    delete obj;
}
#endif

#define XPU_KERNEL_DECL(...)
#if XPU_IS_CUDA
#include <xpu/driver/cuda/cmem_impl.h>
#else // XPU_IS_CPU
#include <xpu/driver/cpu/cmem_impl.h>
#endif
#include XPU_KERNEL_DECL_DEF
#undef XPU_CMEM_DECL
#undef XPU_KERNEL_DECL

#undef LibT
#undef BackendT
#undef LibObject